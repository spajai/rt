%# BEGIN BPS TAGGED BLOCK {{{
%#
%# COPYRIGHT:
%#
%# This software is Copyright (c) 1996-2018 Best Practical Solutions, LLC
%#                                          <sales@bestpractical.com>
%#
%# (Except where explicitly superseded by other copyright notices)
%#
%#
%# LICENSE:
%#
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%#
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%#
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%#
%#
%# CONTRIBUTION SUBMISSION POLICY:
%#
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%#
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%#
%# END BPS TAGGED BLOCK }}}
<& /Elements/CollectionList,
   %ARGS,
   Collection     => $linked_tickets,
   DisplayFormat  => ($Delete? "__CheckBox__, $Format": $Format),
   Format         => $Format,
   Rows           => $Rows,
   ShowHeader     => $ShowHeader,
   OrderBy        => $OrderBy,
   ShowNavigation => 0,
   AllowSorting   => $AllowSorting,
   PassArguments  => $PassArguments,
&>
% unless( $linked_tickets->Count ) {
%   if ( $NoTicketsCaption ) {
        <i>(<% $NoTicketsCaption %>)</i>
%   }
% }
<br />

% if( $FullList && $Rows > 0 && $linked_tickets->CountAll >= $Rows ) {
<a href="<% $FullList %>"><i><% loc("More... ([_1] total)", $linked_tickets->CountAll) %></i></a><br />
% }

<%INIT>
my $linked_tickets = RT::Tickets->new( $session{'CurrentUser'} );
my $ticket_id = $TicketObj->id;

my $query = "Queue = '" . $QueueName . "' AND ". $ExtraQuery;

# As the query below used to find all the linked tickets is in reference to the
# ticket itself, rather than the actual linked ticket, the link type in the query
# will need to be reversed to the correct reference (ie ReferTo becomes ReferredToBy)

my %converted_links = RT::Link->new( $session{'CurrentUser'} )->LinkTypeConversion;
delete $converted_links{ 'MergedInto' };

if ( grep /All/, @$LinkTypes ) {
    @$LinkTypes = keys %converted_links;
}
@$LinkTypes = map { $converted_links{$_} } @$LinkTypes;
my @link_relations = map { $_ . " = $ticket_id" } @$LinkTypes;

my $link_query = join ( ' OR ', @link_relations ); #if scalar @link_relations;
$query = $query . ' AND ( ' . $link_query . ' )' if $link_query;
$linked_tickets->FromSQL( $query );

$Format = RT->Config->Get( 'LinkedQueuesPortletFormat' );

</%INIT>

<%ARGS>
$Format => undef
$OrderBy => 'Due'
$Rows => 0
$Delete => 0
$FullList => undef
$NoTicketsCaption => undef,
$ShowHeader => 0
$AllowSorting => undef
$PassArguments => undef
$ExtraQuery
$LinkTypes
$QueueName
$TicketObj
</%ARGS>
